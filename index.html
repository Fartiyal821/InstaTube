<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InstaTube — Live • Upload • Polls • Story</title>
  <meta name="description" content="InstaTube: a clean, fast, admin-first YouTube × Instagram hybrid. Upload, go live (webcam), run polls, stories, chat. Data persists locally.">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand:#ff0000; /* YouTube red */
      --ink:#e5e7eb;   /* light text on dark */
    }
    html{scroll-behavior:smooth}
    /* Basic theming */
    body{background:#0b0b0f;color:#e5e7eb}
    .glass{backdrop-filter:saturate(120%) blur(10px); background:rgba(255,255,255,0.04);}
    .brand{color:var(--brand)}
    .brand-bg{background:var(--brand)}
    /* Pointer for all clickable controls */
    button,[role="button"],a,.clickable,input[type=checkbox],summary,select,label{cursor:pointer}
    /* Hide elements utility */
    .hidden-tab{display:none}
    /* Scrollbar subtle */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:#20222b;border-radius:9999px}
    .ring-story{box-shadow:0 0 0 3px #000, 0 0 0 5px #22d3ee}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="min-h-screen">
  <!-- Dynamic manifest + SW injected by JS to keep single-file delivery -->
  <script>
    // Create a tiny manifest at runtime so the site can be installed as a PWA.
    const manifest = {
      name:"InstaTube",
      short_name:"InstaTube",
      start_url:"./",
      display:"standalone",
      background_color:"#0b0b0f",
      theme_color:"#ff0000",
      icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='26' fill='%230b0b0f'/><path d='M96 64 48 92V36z' fill='%23ff0000'/></svg>",sizes:"192x192",type:"image/svg+xml"}]
    };
    const mblob = new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const murl = URL.createObjectURL(mblob); const link = document.createElement('link'); link.rel='manifest'; link.href=murl; document.head.appendChild(link);
    // Minimal SW for offline (generated on the fly)
    const swCode = `self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('it-v1').then(c=>c.addAll(['./'])))});
self.addEventListener('activate',e=>self.clients.claim());
self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const cp=res.clone();caches.open('it-v1').then(c=>c.put(e.request,cp));return res;})).catch(()=>new Response('Offline',{status:200})))});`;
    try{const swBlob=new Blob([swCode],{type:'text/javascript'}); const swUrl=URL.createObjectURL(swBlob); navigator.serviceWorker?.register(swUrl);}catch(err){}
  </script>

  <!-- Top Nav -->
  <header class="sticky top-0 z-40 border-b border-white/10 glass">
    <div class="max-w-6xl mx-auto px-3">
      <div class="flex items-center gap-3 py-3">
        <div class="flex items-center gap-2 font-semibold text-lg">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-xl brand-bg text-white">▶</span>
          <span>Insta<span class="brand">Tube</span></span>
        </div>
        <nav class="ml-auto flex items-center gap-1 overflow-x-auto">
          <button data-tab="home" class="px-3 py-1.5 rounded-xl hover:bg-white/10 active:bg-white/20">Home</button>
          <button data-tab="upload" class="px-3 py-1.5 rounded-xl hover:bg-white/10">Upload</button>
          <button data-tab="polls" class="px-3 py-1.5 rounded-xl hover:bg-white/10">Polls</button>
          <button data-tab="live" class="px-3 py-1.5 rounded-xl hover:bg-white/10">Live</button>
          <button data-tab="profile" class="px-3 py-1.5 rounded-xl hover:bg-white/10">Profile</button>
          <button data-tab="story" class="px-3 py-1.5 rounded-xl hover:bg-white/10">Story</button>
        </nav>
        <div class="ml-2 flex items-center gap-2">
          <button id="installBtn" class="px-3 py-1 rounded-xl text-sm bg-white/10 hover:bg-white/20">Install</button>
          <button id="adminBadge" class="px-3 py-1 rounded-xl text-sm bg-emerald-500/15 text-emerald-300 hidden">Admin</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-3 space-y-6">
    <!-- Stories rail (always visible) -->
    <section class="mt-2" aria-label="Stories">
      <div id="storiesRail" class="flex gap-3 overflow-x-auto pb-2"></div>
    </section>

    <!-- HOME -->
    <section id="tab-home" class="space-y-4">
      <div class="flex flex-wrap items-center gap-2">
        <div class="relative flex-1 min-w-[220px]">
          <input id="searchInput" class="w-full bg-white/5 rounded-xl px-4 py-2 pr-9 outline-none focus:ring-2 focus:ring-brand/50" placeholder="Search posts… (title, caption)"/>
          <span class="absolute right-3 top-2.5 opacity-60">⌘K</span>
        </div>
        <select id="sortSelect" class="bg-white/5 rounded-xl px-3 py-2">
          <option value="new">Newest</option>
          <option value="old">Oldest</option>
          <option value="title">Title A→Z</option>
        </select>
        <button id="exportBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Export Data</button>
        <label class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">
          Import <input id="importInput" type="file" class="hidden" accept="application/json"/>
        </label>
      </div>
      <div id="feed" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <p class="opacity-60 text-sm">Images & audio saved as data-URLs. Videos are persisted in IndexedDB. Nothing is uploaded to a server.</p>
    </section>

    <!-- UPLOAD -->
    <section id="tab-upload" class="hidden-tab">
      <div class="grid md:grid-cols-2 gap-4">
        <form id="uploadForm" class="space-y-3 glass rounded-2xl p-4">
          <h2 class="text-lg font-semibold">Upload (Admin)</h2>
          <div class="border-2 border-dashed border-white/15 rounded-2xl p-6 text-center hover:bg-white/5" id="dropZone">
            <p class="mb-2">Drop files here or click to choose</p>
            <input id="fileInput" type="file" accept="video/*,image/*,audio/*" class="mx-auto block" />
          </div>
          <div class="grid gap-3">
            <input id="titleInput" class="bg-white/5 rounded-xl px-3 py-2" placeholder="Title" required />
            <textarea id="captionInput" class="bg-white/5 rounded-xl px-3 py-2" placeholder="Caption" rows="2"></textarea>
            <div class="flex gap-2 items-center">
              <button id="publishBtn" type="submit" class="brand-bg text-white px-4 py-2 rounded-xl disabled:opacity-40">Publish</button>
              <button id="clearBtn" type="button" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Clear</button>
            </div>
            <div id="uploadPreview" class="rounded-xl overflow-hidden bg-black/40 aspect-video grid place-items-center text-sm opacity-80">No preview</div>
          </div>
          <p class="text-sm opacity-70">Only admin can publish. Toggle admin in Profile.</p>
        </form>

        <aside class="space-y-3">
          <div class="glass rounded-2xl p-4">
            <h3 class="font-semibold mb-2">Tips</h3>
            <ul class="list-disc list-inside opacity-80 text-sm space-y-1">
              <li>Videos are stored in your browser using IndexedDB and won’t leave your device.</li>
              <li>Images & audio are embedded as data-URLs in the feed for fast load.</li>
              <li>You can export/import all data from the Home tab.</li>
            </ul>
          </div>
          <div class="glass rounded-2xl p-4">
            <h3 class="font-semibold mb-2">Keyboard</h3>
            <ul class="list-disc list-inside opacity-80 text-sm space-y-1">
              <li><kbd>⌘/Ctrl</kbd> + <kbd>K</kbd> — focus search</li>
              <li><kbd>⌘/Ctrl</kbd> + <kbd>N</kbd> — new upload</li>
            </ul>
          </div>
        </aside>
      </div>
    </section>

    <!-- POLLS -->
    <section id="tab-polls" class="hidden-tab">
      <div class="grid md:grid-cols-2 gap-4">
        <form id="pollForm" class="glass rounded-2xl p-4 space-y-3">
          <h2 class="text-lg font-semibold">Create Poll (Admin)</h2>
          <input id="pollQuestion" class="bg-white/5 rounded-xl px-3 py-2" placeholder="Question" required />
          <div id="pollOptions" class="space-y-2"></div>
          <div class="flex gap-2">
            <button id="addOptionBtn" type="button" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">+ Add Option</button>
            <button id="createPollBtn" type="submit" class="brand-bg text-white px-4 py-2 rounded-xl disabled:opacity-40">Create Poll</button>
          </div>
        </form>
        <div>
          <h3 class="font-semibold mb-2">Active Polls</h3>
          <div id="pollList" class="grid gap-3"></div>
        </div>
      </div>
    </section>

    <!-- LIVE -->
    <section id="tab-live" class="hidden-tab space-y-4">
      <div class="grid lg:grid-cols-3 gap-4">
        <div class="glass rounded-2xl p-4 lg:col-span-2">
          <h2 class="font-semibold mb-3">Go Live (Webcam)</h2>
          <video id="liveVideo" class="w-full aspect-video rounded-xl bg-black" autoplay playsinline muted></video>
          <div class="flex flex-wrap gap-2 mt-3">
            <button id="startWebcamBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Start Webcam</button>
            <button id="stopWebcamBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Stop</button>
            <button id="recordBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">Record Clip</button>
          </div>
        </div>
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold mb-3">RTMP Key (for OBS)</h2>
          <div class="flex gap-2 items-center">
            <input id="streamKey" class="bg-white/5 rounded-xl px-3 py-2 flex-1" placeholder="—" readonly>
            <button id="genKeyBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Generate</button>
          </div>
          <p class="text-sm opacity-70 mt-2">Use with a custom RTMP server: <code>rtmp://YOUR_SERVER/live</code></p>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 glass rounded-2xl p-4">
          <h2 class="font-semibold mb-2">Live Chat</h2>
          <div id="chatBox" class="bg-black/30 rounded-xl p-3 h-64 overflow-y-auto text-sm"></div>
          <form id="chatForm" class="mt-2 flex gap-2">
            <input id="chatInput" class="flex-1 bg-white/5 rounded-xl px-3 py-2" placeholder="Say something…" />
            <button class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Send</button>
          </form>
        </div>
        <div class="glass rounded-2xl p-4">
          <h3 class="font-semibold mb-2">Notes</h3>
          <p class="text-sm opacity-70">This is a local demo. To broadcast publicly, point OBS to your RTMP server and embed the player here.</p>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="tab-profile" class="hidden-tab grid md:grid-cols-2 gap-4">
      <div class="glass rounded-2xl p-4 space-y-3">
        <h2 class="font-semibold">Profile</h2>
        <label class="block text-sm opacity-80">Username</label>
        <input id="usernameInput" class="bg-white/5 rounded-xl px-3 py-2" placeholder="Your name" />
        <button id="saveProfileBtn" class="brand-bg text-white px-4 py-2 rounded-xl">Save Profile</button>
      </div>
      <div class="glass rounded-2xl p-4 space-y-3">
        <h2 class="font-semibold">Admin & Preferences</h2>
        <div class="space-y-2">
          <label class="block">Admin passphrase</label>
          <input id="adminPassInput" class="bg-white/5 rounded-xl px-3 py-2" placeholder="Set or enter passphrase"/>
          <div class="flex gap-2">
            <button id="setAdminBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Set/Update</button>
            <button id="toggleAdminBtn" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Enter Admin Mode</button>
          </div>
          <label class="inline-flex items-center gap-2 mt-2 text-sm opacity-80"><input id="onlyAdminUploads" type="checkbox" class="accent-[var(--brand)]"> Only admin can upload</label>
        </div>
        <div class="pt-2 border-t border-white/10">
          <label class="inline-flex items-center gap-2"><input id="themeToggle" type="checkbox" class="accent-[var(--brand)]"> Light mode</label>
        </div>
      </div>
    </section>

    <!-- STORY -->
    <section id="tab-story" class="hidden-tab">
      <div class="grid md:grid-cols-2 gap-4">
        <form id="storyForm" class="glass rounded-2xl p-4 space-y-3">
          <h2 class="font-semibold">Post Story</h2>
          <input id="storyFile" type="file" accept="image/*,video/*" class="block" />
          <div class="flex gap-2 items-center">
            <button class="brand-bg text-white px-4 py-2 rounded-xl">Post Story</button>
            <span class="text-sm opacity-70">Stories auto-expire after 24 hours.</span>
          </div>
        </form>
        <div>
          <h3 class="font-semibold mb-2">Your Stories</h3>
          <div id="storyList" class="grid gap-3"></div>
        </div>
      </div>
    </section>
  </main>

  <template id="cardTpl">
    <article class="glass rounded-2xl overflow-hidden">
      <div class="aspect-video bg-black grid place-items-center text-sm text-white/60">No media</div>
      <div class="p-3 space-y-2">
        <h3 class="font-semibold line-clamp-2"></h3>
        <p class="text-sm opacity-80 line-clamp-2"></p>
        <div class="flex items-center justify-between text-sm opacity-70">
          <span class="timeago"></span>
          <div class="flex items-center gap-2">
            <button class="likeBtn px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20">♥ <span>0</span></button>
            <button class="commentBtn px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20">💬</button>
            <button class="deleteBtn px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20">🗑</button>
          </div>
        </div>
      </div>
    </article>
  </template>

  <!-- Dialogs -->
  <dialog id="commentDlg" class="rounded-2xl p-0 bg-[#121218] text-inherit w-[min(90vw,520px)]">
    <form method="dialog">
      <header class="p-3 border-b border-white/10 flex items-center justify-between">
        <h4 class="font-semibold">Comments</h4>
        <button value="close" class="px-3 py-1 rounded-xl bg-white/10">✕</button>
      </header>
      <div class="p-3 space-y-3 max-h-[60vh] overflow-y-auto" id="commentsBody"></div>
      <div class="p-3 border-t border-white/10 flex gap-2">
        <input id="commentInput" class="flex-1 bg-white/5 rounded-xl px-3 py-2" placeholder="Add a comment…"/>
        <button id="addCommentBtn" class="px-3 py-2 rounded-xl bg-white/10">Post</button>
      </div>
    </form>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl bg-white/90 text-black shadow hidden">Saved</div>

  <footer class="py-8 text-center opacity-60 text-sm">InstaTube — local demo • vNext</footer>

  <script>
  // =============== UTILITIES ===============
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
  const now = () => Date.now();
  const fmtAgo = ts => {const s=Math.floor((Date.now()-ts)/1000); if(s<60) return `${s}s ago`; const m=Math.floor(s/60); if(m<60) return `${m}m ago`; const h=Math.floor(m/60); if(h<24) return `${h}h ago`; const d=Math.floor(h/24); return `${d}d ago`;};
  const toast = (msg) => {const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500)};
  const uid = (p='id') => p+'-'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4);

  // Storage helpers
  const J = {
    get:(k,def)=>{try{return JSON.parse(localStorage.getItem(k))??def}catch{return def}},
    set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
    del:(k)=>localStorage.removeItem(k)
  };

  // IndexedDB for video blobs
  const IDB = (()=>{
    const DBNAME='instatube'; const STORE='media';
    let dbp=null; const open=()=> dbp||(dbp=new Promise((res,rej)=>{const r=indexedDB.open(DBNAME,1); r.onupgradeneeded=()=>{ try{ r.result.createObjectStore(STORE); }catch(e){} }; r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error)}));
    const put=async(k,blob)=>{const db=await open(); return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(blob,k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error)});}
    const get=async(k)=>{const db=await open(); return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly'); const rq=tx.objectStore(STORE).get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error)});}
    const del=async(k)=>{const db=await open(); return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(k); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error)});}
    return {put,get,del};
  })();

  // Global state
  let state = {
    posts: J.get('IT_posts', []),               // [{id,type,title,caption,createdAt,likes,comments:[{by,text,ts}], dataURL?, mediaKey?}]
    polls: J.get('IT_polls', []),               // [{id,q,opts:[{id,t,votes}], createdAt}]
    profile: J.get('IT_profile',{username:'User'}),
    chat: J.get('IT_chat', []),                 // [{by,text,ts}]
    voted: new Set(J.get('IT_voted', [])),
    stories: J.get('IT_stories', []),           // [{id,type,dataURL?,mediaKey?,createdAt,expiresAt}]
    adminHash: J.get('IT_adminHash', null),
    adminOn: J.get('IT_adminOn', false),
    onlyAdmin: J.get('IT_onlyAdmin', true)
  };

  const save = () => {
    J.set('IT_posts', state.posts);
    J.set('IT_polls', state.polls);
    J.set('IT_profile', state.profile);
    J.set('IT_chat', state.chat);
    J.set('IT_voted', Array.from(state.voted));
    J.set('IT_stories', state.stories);
    J.set('IT_adminHash', state.adminHash);
    J.set('IT_adminOn', state.adminOn);
    J.set('IT_onlyAdmin', state.onlyAdmin);
  };

  // Simple hash for passphrase (not secure, just for demo)
  const hash = str => Array.from(new TextEncoder().encode(str)).reduce((a,b)=>((a<<5)-a)+b,0)>>>0;

  // =============== NAVIGATION ===============
  const activateTab = (name) => {
    $$('[id^="tab-"]').forEach(s=>s.classList.add('hidden-tab'));
    $(`#tab-${name}`).classList.remove('hidden-tab');
    $$('header nav button').forEach(b=>b.classList.remove('bg-white/20'));
    const btn = document.querySelector(`header nav button[data-tab="${name}"]`);
    if(btn) btn.classList.add('bg-white/20');
    if(name==='home') renderFeed();
    if(name==='polls') renderPolls();
    if(name==='story') renderStories();
  };
  $$('header nav button').forEach(b=> b.addEventListener('click',()=>activateTab(b.dataset.tab)));
  activateTab('home');

  // =============== INSTALL PROMPT ===============
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; $('#installBtn').disabled=false; });
  $('#installBtn').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt=null; });

  // =============== PROFILE / ADMIN ===============
  const syncAdminUI = () => {
    $('#adminBadge').classList.toggle('hidden', !state.adminOn);
    $('#onlyAdminUploads').checked = !!state.onlyAdmin;
  };
  syncAdminUI();

  $('#saveProfileBtn').addEventListener('click', ()=>{ state.profile.username = $('#usernameInput').value.trim()||'User'; save(); toast('Profile saved'); });
  $('#usernameInput').value = state.profile.username;

  $('#setAdminBtn').addEventListener('click', ()=>{
    const v = $('#adminPassInput').value.trim(); if(!v){toast('Enter a passphrase'); return;}
    state.adminHash = hash(v); save(); toast('Admin passphrase set');
  });
  $('#toggleAdminBtn').addEventListener('click', ()=>{
    const v = $('#adminPassInput').value.trim(); if(!v){toast('Enter passphrase to toggle'); return;}
    if(state.adminHash && state.adminHash===hash(v)) { state.adminOn=!state.adminOn; save(); syncAdminUI(); toast(state.adminOn?'Admin ON':'Admin OFF'); }
    else toast('Wrong passphrase');
  });
  $('#onlyAdminUploads').addEventListener('change', (e)=>{ state.onlyAdmin = e.target.checked; save(); })

  // Light theme toggle
  const applyTheme = () => {
    const light = J.get('IT_themeLight', false); document.body.classList.toggle('bg-white', light); document.body.classList.toggle('text-black', light);
  };
  $('#themeToggle').checked = J.get('IT_themeLight', false);
  $('#themeToggle').addEventListener('change', (e)=>{ J.set('IT_themeLight', e.target.checked); applyTheme(); });
  applyTheme();

  // =============== UPLOAD ===============
  const dropZone = $('#dropZone');
  const fileInput = $('#fileInput');
  const preview = $('#uploadPreview');

  const setPreview = async (file) => {
    if(!file){ preview.textContent='No preview'; preview.style.backgroundImage='none'; preview.innerHTML='No preview'; return; }
    if(file.type.startsWith('image/')){
      const url = URL.createObjectURL(file);
      preview.innerHTML = `<img src="${url}" alt="preview" class="w-full h-full object-contain">`;
    } else if(file.type.startsWith('video/')){
      const v = document.createElement('video'); v.controls=false; v.muted=true; v.src=URL.createObjectURL(file); v.className='w-full h-full object-contain'; preview.innerHTML=''; preview.appendChild(v); v.play().catch(()=>{});
    } else if(file.type.startsWith('audio/')){
      preview.innerHTML = `<div class="p-4">Audio selected: <span class="opacity-70 text-sm">${file.name}</span></div>`;
    } else {
      preview.textContent='Unsupported file type';
    }
  };

  dropZone.addEventListener('click', ()=> fileInput.click());
  dropZone.addEventListener('dragover', e=>{e.preventDefault(); dropZone.classList.add('bg-white/5')});
  dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('bg-white/5'));
  dropZone.addEventListener('drop', e=>{ e.preventDefault(); dropZone.classList.remove('bg-white/5'); const f=e.dataTransfer.files?.[0]; if(f){ fileInput.files = e.dataTransfer.files; setPreview(f); }});
  fileInput.addEventListener('change', e=> setPreview(e.target.files?.[0]));

  $('#clearBtn').addEventListener('click', ()=>{ fileInput.value=''; $('#titleInput').value=''; $('#captionInput').value=''; setPreview(null); })

  $('#uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(state.onlyAdmin && !state.adminOn){ toast('Admin required to publish'); return; }
    const f=fileInput.files?.[0]; if(!f){toast('Pick a file'); return;}
    const title=$('#titleInput').value.trim()||f.name; const caption=$('#captionInput').value.trim();
    const id=uid('post'); const createdAt=now(); let type='other'; let dataURL=null; let mediaKey=null;
    if(f.type.startsWith('image/')){ type='image'; dataURL = await fileToDataURL(f); }
    else if(f.type.startsWith('video/')){ type='video'; mediaKey=id; await IDB.put(mediaKey, f); }
    else if(f.type.startsWith('audio/')){ type='audio'; dataURL = await fileToDataURL(f); }
    else { toast('Unsupported file'); return; }

    const post={id,type,title,caption,createdAt,likes:0,comments:[], by: state.profile.username, dataURL, mediaKey};
    state.posts.unshift(post); save(); toast('Published'); fileInput.value=''; $('#titleInput').value=''; $('#captionInput').value=''; setPreview(null); renderFeed(); activateTab('home');
  });

  const fileToDataURL = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

  // =============== FEED ===============
  const feed = $('#feed');
  function renderFeed(){
    const q = $('#searchInput').value.toLowerCase();
    let posts=[...state.posts];
    const sort=$('#sortSelect').value;
    if(sort==='old') posts.sort((a,b)=>a.createdAt-b.createdAt);
    else if(sort==='title') posts.sort((a,b)=> a.title.localeCompare(b.title));
    else posts.sort((a,b)=>b.createdAt-a.createdAt);
    if(q) posts = posts.filter(p=> (p.title+" "+p.caption).toLowerCase().includes(q));

    feed.innerHTML='';
    for(const p of posts){ feed.appendChild(renderCard(p)); }
    if(!posts.length){ feed.innerHTML = `<div class="opacity-60 p-8 text-center">No posts yet.</div>`; }
  }

  function renderCard(p){
    const tpl = $('#cardTpl').content.cloneNode(true);
    const card = tpl.querySelector('article');
    card.dataset.id=p.id;
    const media = card.querySelector('.aspect-video');
    const title = card.querySelector('h3'); title.textContent=p.title;
    const cap = card.querySelector('p'); cap.textContent=p.caption;
    const time = card.querySelector('.timeago'); time.textContent=fmtAgo(p.createdAt);
    const likeBtn = card.querySelector('.likeBtn'); likeBtn.querySelector('span').textContent=p.likes;

    // Media rendering: image | audio | video (dataURL or mediaKey)
    if(p.type==='image' && p.dataURL){ media.innerHTML=`<img src="${p.dataURL}" alt="${p.title}" class="w-full h-full object-cover">`; }
    else if(p.type==='audio' && p.dataURL){ media.innerHTML=`<audio controls class="w-full"><source src="${p.dataURL}"></audio>`; }
    else if(p.type==='video'){
      if(p.dataURL){
        media.innerHTML=`<video controls class="w-full h-full object-contain"><source src="${p.dataURL}"></video>`;
      } else if(p.mediaKey){
        // lazy create object URL
        IDB.get(p.mediaKey).then(blob=>{ if(!blob) return; const url=URL.createObjectURL(blob); media.innerHTML=`<video controls class="w-full h-full object-contain"><source src="${url}"></video>`; });
      } else if(p.url){
        media.innerHTML=`<video controls class="w-full h-full object-contain"><source src="${p.url}"></video>`;
      } else {
        media.innerHTML=`<div class="p-6 text-sm opacity-70">Video</div>`;
      }
    }

    likeBtn.addEventListener('click', ()=>{ p.likes++; likeBtn.querySelector('span').textContent=p.likes; save(); });

    const commentBtn = card.querySelector('.commentBtn');
    commentBtn.addEventListener('click', ()=> openComments(p));

    const delBtn = card.querySelector('.deleteBtn'); delBtn.addEventListener('click', async ()=>{
      if(!state.adminOn){ toast('Admin required'); return; }
      if(confirm('Delete this post?')){
        state.posts = state.posts.filter(x=>x.id!==p.id); if(p.mediaKey) await IDB.del(p.mediaKey); save(); renderFeed(); toast('Deleted');
      }
    });

    // Share: copy a deep link (hash with id)
    const shareBtn = el('button',{className:'px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20', innerText:'Share'});
    shareBtn.addEventListener('click', ()=>{
      const link = `${location.origin}${location.pathname}#post=${p.id}`;
      navigator.clipboard?.writeText(link).then(()=>toast('Link copied'));
    });
    const actions = card.querySelector('.flex.items-center.gap-2');
    if(actions) actions.appendChild(shareBtn);

    return card;
  }

  // Open by hash if present
  function tryOpenFromHash(){
    const h = location.hash.slice(1);
    if(!h) return;
    const m = h.match(/post=([^&]+)/);
    if(m){
      const id = m[1];
      const p = state.posts.find(x=>x.id===id);
      if(p){ activateTab('home'); setTimeout(()=>{ const a = document.querySelector(`#feed article[data-id="${id}"]`); if(a) a.scrollIntoView({behavior:'smooth', block:'center'}); },200); }
    }
  }

  // Comments dialog
  const cdlg = $('#commentDlg');
  let commentForId=null;
  function openComments(p){
    commentForId=p.id;
    $('#commentsBody').innerHTML = p.comments.map(c=>`<div class='p-2 rounded-xl bg-white/5'><div class='text-sm font-semibold'>${c.by} <span class='opacity-60 text-xs'>${fmtAgo(c.ts)}</span></div><div>${c.text}</div></div>`).join('');
    cdlg.showModal();
  }
  $('#addCommentBtn').addEventListener('click', (e)=>{
    e.preventDefault(); const text=$('#commentInput').value.trim(); if(!text) return;
    const p=state.posts.find(x=>x.id===commentForId); if(!p) return;
    p.comments.push({by: state.profile.username, text, ts: now()}); $('#commentInput').value=''; save(); openComments(p);
  })

  // Search + sort + keyboard
  $('#searchInput').addEventListener('input', renderFeed);
  $('#sortSelect').addEventListener('change', renderFeed);
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#searchInput').focus(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); activateTab('upload'); fileInput.click(); }
  });

  // Export/Import
  $('#exportBtn').addEventListener('click', async ()=>{
    const dump = {...state, voted:Array.from(state.voted)};
    const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
    const a=el('a',{href:URL.createObjectURL(blob), download:'instatube-backup.json'}); a.click();
  });
  $('#importInput').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
    try{ const obj=JSON.parse(txt); state.posts=obj.posts||[]; state.polls=obj.polls||[]; state.profile=obj.profile||state.profile; state.chat=obj.chat||[]; state.voted = new Set(obj.voted||[]); state.stories=obj.stories||[]; state.adminHash=obj.adminHash||null; state.onlyAdmin=!!obj.onlyAdmin; save(); toast('Imported'); renderFeed(); renderPolls(); renderStories(); }
    catch{ toast('Invalid file'); }
  });

  // =============== POLLS ===============
  const pollOptions = $('#pollOptions');
  const mkOpt = (val='') => `<div class='flex gap-2'><input class="bg-white/5 rounded-xl px-3 py-2 flex-1" placeholder="Option" value="${val}"><button type='button' class='removeOpt px-2 rounded-lg bg-white/10'>✕</button></div>`;
  const ensureTwo = ()=>{ if(!pollOptions.children.length){ pollOptions.insertAdjacentHTML('beforeend', mkOpt()); pollOptions.insertAdjacentHTML('beforeend', mkOpt()); }};
  ensureTwo();

  $('#addOptionBtn').addEventListener('click', ()=> pollOptions.insertAdjacentHTML('beforeend', mkOpt()));
  pollOptions.addEventListener('click', (e)=>{ if(e.target.closest('.removeOpt')) e.target.closest('div').remove(); if(pollOptions.children.length<2) ensureTwo(); });

  $('#pollForm').addEventListener('submit', (e)=>{
    e.preventDefault(); if(state.onlyAdmin && !state.adminOn){ toast('Admin required to create'); return; }
    const q=$('#pollQuestion').value.trim(); if(!q) return toast('Enter a question');
    const opts=[...pollOptions.querySelectorAll('input')].map(i=>i.value.trim()).filter(Boolean);
    if(opts.length<2) return toast('At least 2 options');
    const poll={id:uid('poll'), q, opts:opts.map(t=>({id:uid('opt'), t, votes:0})), createdAt: now()};
    state.polls.unshift(poll); save(); $('#pollQuestion').value=''; pollOptions.innerHTML=''; ensureTwo(); renderPolls(); toast('Poll created');
  });

  function renderPolls(){
    const box = $('#pollList'); box.innerHTML='';
    for(const p of state.polls){
      const total = p.opts.reduce((a,b)=>a+b.votes,0) || 1;
      const wrap = el('div',{className:'glass rounded-2xl p-4 space-y-3'});
      wrap.innerHTML = `<div class='font-semibold'>${p.q}</div>` + p.opts.map(o=>{
        const pct = Math.round((o.votes/total)*100);
        return `<div class='space-y-1'>
            <div class='flex items-center justify-between text-sm'><span>${o.t}</span><span class='opacity-70'>${pct}% (${o.votes})</span></div>
            <div class='w-full h-2 bg-white/10 rounded-full overflow-hidden'><div style='width:${pct}%' class='h-full brand-bg'></div></div>
            <button data-poll='${p.id}' data-opt='${o.id}' class='vote px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20'>Vote</button>
        </div>`;
      }).join('');
      box.appendChild(wrap);
    }
  }

  $('#pollList').addEventListener('click', (e)=>{
    const btn = e.target.closest('.vote'); if(!btn) return; const pid=btn.dataset.poll, oid=btn.dataset.opt;
    if(state.voted.has(pid)) return toast('Already voted');
    const p = state.polls.find(x=>x.id===pid); const o = p?.opts.find(x=>x.id===oid); if(!o) return;
    o.votes++; state.voted.add(pid); save(); renderPolls();
  });

  // =============== LIVE (webcam + chat) ===============
  let stream=null; let recorder=null; let chunks=[];
  $('#startWebcamBtn').addEventListener('click', async ()=>{
    if(state.onlyAdmin && !state.adminOn) return toast('Admin required');
    try{ stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true}); $('#liveVideo').srcObject=stream; }
    catch(err){ toast('Permission denied'); }
  });
  $('#stopWebcamBtn').addEventListener('click', ()=>{ stream?.getTracks().forEach(t=>t.stop()); $('#liveVideo').srcObject=null; stream=null; });
  $('#recordBtn').addEventListener('click', ()=>{
    if(!stream) return toast('Start webcam first');
    if(recorder?.state==='recording'){ recorder.stop(); return; }
    chunks=[]; recorder=new MediaRecorder(stream); recorder.ondataavailable=e=>chunks.push(e.data); recorder.onstop=async ()=>{
      const blob=new Blob(chunks,{type:'video/webm'}); const id=uid('clip'); await IDB.put(id, blob); const post={id, type:'video', title:'Live clip', caption:'Recorded from webcam', createdAt:now(), likes:0, comments:[], by:state.profile.username, mediaKey:id}; state.posts.unshift(post); save(); renderFeed(); toast('Clip saved to Home'); activateTab('home');
    }; recorder.start(); toast('Recording… click again to stop');
  });

  // Stream key
  $('#genKeyBtn').addEventListener('click', ()=>{ if(state.onlyAdmin && !state.adminOn) return toast('Admin required'); $('#streamKey').value = uid('rtmp'); navigator.clipboard.writeText($('#streamKey').value).catch(()=>{}); toast('Key generated & copied'); });

  // Chat
  function renderChat(){ $('#chatBox').innerHTML = state.chat.map(c=>`<div class='mb-1'><span class='font-semibold'>${c.by}</span>: ${c.text} <span class='opacity-60 text-xs'>${fmtAgo(c.ts)}</span></div>`).join(''); $('#chatBox').scrollTop = 1e9; }
  renderChat();
  $('#chatForm').addEventListener('submit', (e)=>{ e.preventDefault(); const text=$('#chatInput').value.trim(); if(!text) return; state.chat.push({by: state.profile.username, text, ts: now()}); $('#chatInput').value=''; save(); renderChat(); });

  // =============== STORIES ===============
  const day = 24*60*60*1000;
  function purgeStories(){ const t=now(); state.stories = state.stories.filter(s=> s.expiresAt>t); save(); }
  function renderStories(){ purgeStories();
    // List
    const list = $('#storyList'); list.innerHTML='';
    for(const s of state.stories){ const item=el('div',{className:'glass rounded-2xl overflow-hidden'}); item.innerHTML = storyMediaHTML(s); list.appendChild(item); }
    // Rail
    const rail = $('#storiesRail'); rail.innerHTML = state.stories.map(s=>`<button class='shrink-0 w-16 h-16 rounded-full overflow-hidden ring-story'><img class='w-full h-full object-cover' src='${s.thumb||placeholderThumb()}' alt='story'></button>`).join('');
  }

  function storyMediaHTML(s){ if(s.type==='image' && s.dataURL) return `<img src='${s.dataURL}' class='w-full h-full object-cover' alt='story'>`; if(s.type==='video' && s.mediaKey) return `<video controls class='w-full h-full'><source src='' ></video>`; return `<div class='p-6 text-sm opacity-70'>Story</div>`; }

  $('#storyForm').addEventListener('submit', async (e)=>{
    e.preventDefault(); if(state.onlyAdmin && !state.adminOn) return toast('Admin required'); const f=$('#storyFile').files?.[0]; if(!f) return toast('Pick a file');
    const id=uid('story'); const createdAt=now(); const expiresAt=createdAt+day;
    let s={id, createdAt, expiresAt, type:'image'};
    if(f.type.startsWith('image/')){ s.type='image'; s.dataURL=await fileToDataURL(f); s.thumb=s.dataURL; }
    else if(f.type.startsWith('video/')){ s.type='video'; s.mediaKey=id; await IDB.put(id, f); s.thumb=placeholderThumb(); }
    state.stories.unshift(s); save(); $('#storyFile').value=''; renderStories(); toast('Story posted');
  })

  const placeholderThumb = ()=>`data:image/svg+xml;utf8,${encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 120'><rect width='200' height='120' fill='#111'/><path d='M140 60 80 95V25z' fill='%23ff0000'/></svg>`)}`;

  // =============== SMALL UX EXTRAS ===============
  // Focus states on nav
  $$('header nav button').forEach(b=>{ b.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); b.click(); }}); });
  // Keep timeago fresh
  setInterval(()=> $$('#feed .timeago').forEach(t=>{ const id=t.closest('article')?.dataset.id; const p=state.posts.find(x=>x.id===id); if(p) t.textContent=fmtAgo(p.createdAt); }), 30_000);

  // =============== DEMO POST (only if feed empty) ===============
  (async ()=>{
    if(!state.posts.length){
      // Demo uses an external short MP4 for convenience (not persisted to IDB).
      const demo = {
        id: uid('demo'),
        type: 'video',
        title: 'Demo: Big Buck Bunny (sample)',
        caption: 'Welcome to InstaTube — demo video. Try Like, Comment, Record, or Upload your own.',
        createdAt: now()-1000*60*60,
        likes: 12,
        comments: [{by:'DemoUser', text:'Nice demo!', ts: now()-1000*60}],
        by: 'InstaTube',
        url: 'https://www.w3schools.com/html/mov_bbb.mp4' // external sample video
      };
      state.posts.unshift(demo);
      save();
    }
    renderFeed();
    tryOpenFromHash();
    renderPolls();
    renderStories();
  })();

  // Open comments if hash comment param present (not required but handy)
  // =============== OPEN HASH HANDLING DONE ABOVE ===============

  </script>
</body>
</html>
